<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>釣魚冒險 indev-250325</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #87CEEB;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px;
        }
        .game-area {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            min-height: 400px;
        }
        .fishing-spot {
            width: 100%;
            height: 300px;
            background: linear-gradient(0deg, #0a4da8 0%, #1e65c7 40%, #2e8cb8 100%);
            border-radius: 5px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
            z-index: 5; /* 確保釣魚區域有適當的z-index */
        }
        
        .fishing-spot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.05) 100%);
            animation: wave 8s linear infinite;
            z-index: 1;
        }
        
        .fishing-spot::after {
            content: '';
            position: absolute;
            top: 40%;
            left: -50%;
            width: 200%;
            height: 60%;
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.05) 100%);
            animation: wave 10s linear infinite reverse;
            z-index: 2;
        }
        
        /* 添加第三層波浪 */
        .fishing-spot .wave3 {
            content: '';
            position: absolute;
            top: 60%;
            left: -30%;
            width: 200%;
            height: 40%;
            background: linear-gradient(90deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.02) 100%);
            animation: wave 6s linear infinite;
            z-index: 3;
        }
        
        /* 添加水面反光效果 */
        .fishing-spot .reflection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            opacity: 0.5;
            animation: reflection 5s ease-in-out infinite alternate;
            z-index: 4;
        }
        
        @keyframes wave {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        @keyframes reflection {
            0% { opacity: 0.3; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(1.1); }
        }
        
        /* 添加額外的波浪效果 */
        .fishing-spot::before, .fishing-spot::after, .fishing-spot .wave3 {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }
        .progress-container {
            width: 80%;
            height: 30px;
            background-color: #ddd;
            border-radius: 15px;
            margin: 10px auto;
            display: none;
            position: relative;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            border: 1px solid #ccc;
            overflow: hidden;
            z-index: 2000; /* 增加z-index確保進度條顯示在最上層 */
            opacity: 1 !important;
            visibility: visible !important; /* 確保可見性 */
            pointer-events: auto !important; /* 確保可以接收點擊事件 */
        }
        
        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(to right, #4CAF50, #8BC34A);
            border-radius: 15px;
            transition: width 0.1s;
            position: relative;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
            display: block; /* 確保進度條始終顯示 */
            opacity: 1;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, 
                        rgba(255, 255, 255, 0.3) 0%, 
                        rgba(255, 255, 255, 0.1) 50%, 
                        rgba(255, 255, 255, 0) 51%, 
                        rgba(255, 255, 255, 0) 100%);
        }
        .fish-animation {
            position: absolute;
            width: 50px;
            height: 30px;
            background-color: orange;
            border-radius: 50% 70% 70% 50%;
            display: none;
            z-index: 15;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            animation: swim 2s ease-in-out infinite;
            overflow: hidden;
            pointer-events: none; /* 確保魚的動畫不會阻擋點擊事件 */
        }
        
        .fish-animation::before { /* 魚鰭 */
            content: '';
            position: absolute;
            top: 10px;
            right: 5px;
            width: 15px;
            height: 15px;
            background-color: rgba(255, 165, 0, 0.8);
            border-radius: 50% 0 50% 0;
            transform: rotate(45deg);
        }
        
        .fish-animation::after { /* 魚眼 */
            content: '';
            position: absolute;
            top: 8px;
            left: 10px;
            width: 6px;
            height: 6px;
            background-color: black;
            border-radius: 50%;
            box-shadow: 0 0 2px 1px white;
        }
        
        @keyframes swim {
            0% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(5px) rotate(2deg); }
            50% { transform: translateY(3px); }
            75% { transform: translateX(-5px) rotate(-2deg); }
            100% { transform: translateX(0) rotate(0deg); }
        }
        .rod-button {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, #b67f4e, #8B4513);
            border-radius: 50%;
            display: none;
            cursor: pointer;
            animation: shake 0.5s infinite;
            color: white;
            font-weight: bold;
            text-align: center;
            line-height: 60px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5), inset 0 0 5px rgba(255, 255, 255, 0.3);
            border: 2px solid #6d3300;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            transition: transform 0.1s, box-shadow 0.1s;
            z-index: 3000; /* 增加z-index確保釣竿按鈕顯示在最上層 */
            pointer-events: auto !important; /* 確保可以接收點擊事件 */
        }
        
        .rod-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.4);
        }
        
        @keyframes shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(2px, 2px) rotate(2deg); }
            50% { transform: translate(0, 0) rotate(0deg); }
            75% { transform: translate(-2px, 2px) rotate(-2deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .sidebar {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
        }
        .inventory {
            margin-bottom: 20px;
        }
        .stats {
            margin-bottom: 20px;
        }
        .shop-button, .map-button, .fish-button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: linear-gradient(to bottom, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        
        .shop-button:hover, .map-button:hover, .fish-button:hover {
            background: linear-gradient(to bottom, #45a049, #3d8b3d);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .shop-button:active, .map-button:active, .fish-button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 5000;
            opacity: 0;
            transition: opacity 0.3s ease;
            /* 添加flexbox佈局實現完美置中 */
            justify-content: center;
            align-items: center;
            pointer-events: none; /* 初始狀態下不接收點擊事件 */
        }
        
        .modal.show {
            opacity: 1;
            display: flex; /* 確保顯示時也使用flexbox */
            pointer-events: auto; /* 顯示時接收點擊事件 */
        }
        
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.3s ease;
            /* 移除margin設定，由flexbox控制置中 */
            pointer-events: auto; /* 確保可以接收點擊事件 */
            z-index: 5001; /* 確保內容在模態框之上 */
        }
        
        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        .modal h2 {
            color: #2e8cb8;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .modal button {
            background: linear-gradient(to bottom, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .modal button:hover {
            background: linear-gradient(to bottom, #45a049, #3d8b3d);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-area">
            <div class="fishing-spot" id="fishingSpot">
                <!-- 釣魚動畫和魚會在這裡顯示 -->
                <div class="wave3"></div>
                <div class="reflection"></div>
                <div class="fish-animation" id="fishAnimation"></div>
                <div class="rod-button" id="rodButton">釣竿</div>
            </div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <button class="fish-button" onclick="startFishing()" style="z-index: 50; position: relative;">開始釣魚</button>
        </div>
        <div class="sidebar">
            <div class="stats">
                <h3>狀態</h3>
                <p>金錢: <span id="money">100</span></p>
                <p>當前釣竿: <span id="currentRod">初級釣竿</span></p>
            </div>
            <div class="inventory">
                <h3>背包</h3>
                <div id="inventoryList"></div>
            </div>
            <button class="shop-button" onclick="openShop()" style="z-index: 50; position: relative;">商店</button>
            <button class="map-button" onclick="openMap()" style="z-index: 50; position: relative;">地圖</button>
        </div>
    </div>

    <!-- 商店彈窗 -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <h2>商店</h2>
            <div id="shopItems"></div>
            <span onclick="closeShop()" style="position: absolute; top: 10px; right: 15px; color: red; cursor: pointer; font-weight: bold;">X</span>
        </div>
    </div>

    <!-- 地圖彈窗 -->
    <div id="mapModal" class="modal">
        <div class="modal-content">
            <h2>探索地圖 <span style="font-size: 0.8em; color: #4CAF50;">(金錢: <span id="mapModalMoney">0</span>)</span></h2>
            <div id="mapLocations"></div>
            <span onclick="closeMap()" style="position: absolute; top: 10px; right: 15px; color: red; cursor: pointer; font-weight: bold;">X</span>
        </div>
    </div>

    <script>
        // 遊戲數據 - 設為全局變量
        window.gameData = {
            money: 100,
            currentRod: {
                name: "初級釣竿",
                power: 1,
                price: 0
            },
            inventory: [],
            currentLocation: "淺灘",
            version: "indev-250325" // 版本號
        };

        // 釣竿商店數據
        const rods = [
            { name: "中級釣竿", power: 2, price: 200 },
            { name: "高級釣竿", power: 3, price: 500 },
            { name: "專業釣竿", power: 4, price: 1000 },
            { name: "碳纖維釣竿", power: 5, price: 2000 },
            { name: "鑽石釣竿", power: 7, price: 5000 },
            { name: "傳說釣竿", power: 10, price: 10000 }
        ];

        // 魚類數據
        const fishes = {
            淺灘: [
                { name: "小鯉魚", price: 10, chance: 0.7 },
                { name: "河豚", price: 20, chance: 0.3 }
            ],
            深海: [
                { name: "金槍魚", price: 50, chance: 0.4 },
                { name: "鯊魚", price: 100, chance: 0.1 }
            ],
            珊瑚礁: [
                { name: "熱帶魚", price: 30, chance: 0.6 },
                { name: "章魚", price: 80, chance: 0.2 }
            ],
            湖泊: [
                { name: "黑鱸魚", price: 25, chance: 0.5 },
                { name: "鱘魚", price: 70, chance: 0.3 },
                { name: "巨型鯰魚", price: 120, chance: 0.2 }
            ],
            河流: [
                { name: "鱒魚", price: 15, chance: 0.6 },
                { name: "鮭魚", price: 40, chance: 0.3 },
                { name: "彩虹魚", price: 90, chance: 0.1 }
            ],
            深淵: [
                { name: "深海鰻", price: 150, chance: 0.4 },
                { name: "發光魚", price: 200, chance: 0.3 },
                { name: "深淵巨獸", price: 500, chance: 0.05 },
                { name: "幽靈魚", price: 300, chance: 0.25 }
            ],
            冰湖: [
                { name: "冰魚", price: 60, chance: 0.5 },
                { name: "雪花魚", price: 120, chance: 0.3 },
                { name: "冰晶龍魚", price: 350, chance: 0.2 }
            ]
        };
        
        // 地點傳送費用
        const travelCosts = {
            淺灘: 0, // 初始地點免費
            深海: 100,
            珊瑚礁: 150,
            湖泊: 50,
            河流: 80,
            深淵: 300,
            冰湖: 200
        };

        // 釣魚功能
        let isFishing = false;
        let fishCaught = null;
        let progressInterval = null;
        let progressValue = 0;
        let progressDecay = 1.5; // 調整衰減速率為0.5，使遊戲更平衡
        let clickPower = 8; // 增加點擊力量，從5改為8
        let fishingStage = 0; // 0: 未釣魚, 1: 釣竿階段, 2: 進度條階段
        let rodTouchCount = 0; // 記錄玩家觸碰釣竿按鈕的次數
        let rodTouchTarget = 0; // 需要觸碰的目標次數

        // 釣魚超時計時器ID
        let fishingTimeoutId = null;
        
        function startFishing() {
            // 如果已經在釣魚中，直接返回
            if (isFishing) return;
            
            // 獲取所有需要的DOM元素
            const fishButton = document.querySelector('.fish-button');
            const fishingSpot = document.getElementById('fishingSpot');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const fishAnimation = document.getElementById('fishAnimation');
            const rodButton = document.getElementById('rodButton');
            
            console.log('開始釣魚函數被調用');
            
            // 確保在開始新的釣魚過程前清除所有可能存在的計時器
            if (progressInterval) {
                console.log('清除之前可能存在的進度條計時器');
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            if (fishingTimeoutId) {
                console.log('清除之前可能存在的釣魚超時計時器');
                clearTimeout(fishingTimeoutId);
                fishingTimeoutId = null;
            }
            
            // 重置所有釣魚相關狀態
            fishButton.disabled = true;
            fishButton.textContent = '釣魚中...';
            isFishing = true;
            fishingStage = 1; // 進入釣竿階段
            
            // 重置觸碰計數器並設置目標次數（5-10之間的隨機數，降低難度）
            rodTouchCount = 0;
            rodTouchTarget = Math.floor(Math.random() * 6) + 5; // 5到10之間的隨機數
            console.log(`釣竿階段：需要點擊 ${rodTouchTarget} 次`);
            
            // 第一階段：顯示釣竿按鈕
            rodButton.style.display = 'block';
            rodButton.style.left = Math.random() * (fishingSpot.offsetWidth - 60) + 'px';
            rodButton.style.top = Math.random() * (fishingSpot.offsetHeight - 60) + 'px';
            
            // 確保移除之前的事件監聽器
            rodButton.onclick = null;
            fishingSpot.onclick = null;
            
            // 設置釣竿按鈕點擊事件
            rodButton.onclick = function(event) {
                if (event) {
                    event.stopPropagation(); // 防止事件冒泡到fishingSpot
                }
                
                // 確保我們仍然在釣竿階段
                if (fishingStage !== 1 || !isFishing) {
                    console.log('釣竿點擊被忽略，當前階段不是釣竿階段或釣魚已停止');
                    return;
                }
                
                // 增加觸碰計數
                rodTouchCount++;
                console.log(`釣竿按鈕點擊: ${rodTouchCount}/${rodTouchTarget}`);
                
                // 如果還沒達到目標次數，則移動釣竿按鈕到新位置
                if (rodTouchCount < rodTouchTarget) {
                    rodButton.style.left = Math.random() * (fishingSpot.offsetWidth - 60) + 'px';
                    rodButton.style.top = Math.random() * (fishingSpot.offsetHeight - 60) + 'px';
                    return;
                }
                
                // 達到目標次數後，隱藏釣竿按鈕並進入進度條階段
                console.log('達到目標點擊次數，進入進度條階段');
                rodButton.style.display = 'none';
                fishingStage = 2; // 進入進度條階段
                
                // 清除釣竿階段的超時計時器
                if (fishingTimeoutId) {
                    clearTimeout(fishingTimeoutId);
                    fishingTimeoutId = null;
                }
                
                // 檢查是否有魚上鉤
                fishCaught = checkForFish();
                console.log('魚上鉤檢查結果:', fishCaught);
                
                if (fishCaught) {
                    try {
                        // 顯示魚的動畫
                        fishAnimation.style.display = 'block';
                        fishAnimation.style.left = Math.random() * (fishingSpot.offsetWidth - 50) + 'px';
                        fishAnimation.style.top = Math.random() * (fishingSpot.offsetHeight - 30) + 'px';
                        console.log('魚的動畫已顯示');
                        
                        // 顯示進度條 - 添加強制重繪機制
                        progressContainer.style.display = 'block'; // 直接顯示
                        progressValue = 30; // 起始進度
                        progressBar.style.width = progressValue + '%';
                        // 確保進度條可見
                        progressBar.style.display = 'block';
                        console.log('進度條顯示狀態:', progressContainer.style.display, progressBar.style.display);
                        console.log('進度條已顯示，初始進度值:', progressValue);
                        
                        // 設置點擊事件
                        fishingSpot.onclick = function() {
                            console.log('釣魚區域被點擊，當前階段:', fishingStage);
                            if (isFishing && fishCaught && fishingStage === 2) {
                                progressValue += clickPower;
                                console.log('進度增加，當前進度:', progressValue);
                                if (progressValue > 100) progressValue = 100;
                                progressBar.style.width = progressValue + '%';
                                
                                if (progressValue >= 100) {
                                    // 釣魚成功
                                    console.log('釣魚成功！進度達到100%');
                                    if (progressInterval) {
                                        clearInterval(progressInterval);
                                        progressInterval = null;
                                    }
                                    completeFishing(true);
                                }
                            }
                        };
                        
                        // 設置進度條衰減
                        if (progressInterval) {
                            clearInterval(progressInterval);
                            progressInterval = null;
                        }
                        
                        progressInterval = setInterval(() => {
                            // 確保我們仍然在進度條階段
                            if (fishingStage !== 2 || !isFishing) {
                                console.log('釣魚已停止，清除進度條計時器');
                                clearInterval(progressInterval);
                                progressInterval = null;
                                return;
                            }
                            
                            // 進度條隨時間衰減
                            console.log('進度條衰減中，當前進度:', progressValue);
                            progressValue -= progressDecay; // 恢復進度條衰減
                            progressBar.style.width = progressValue + '%';
                            
                            // 由於progressDecay為0，進度不會降到0，但保留檢查邏輯以防萬一
                            if (progressValue <= 0) {
                                console.log('進度為0，但不會自動失敗');
                                // 不再自動結束釣魚
                                // clearInterval(progressInterval);
                                // progressInterval = null;
                                // completeFishing(false);
                            }
                        }, 100);
                        
                        // 移除釣魚超時機制，讓玩家有充足的時間釣魚
                        // 注意：原本的超時計時器已被移除，玩家可以無限時間釣魚
                        console.log('進度條階段開始，玩家可以無限時間釣魚');
                        // fishingTimeoutId 設為 null，確保不會有超時處理
                        fishingTimeoutId = null;
                    } catch (error) {
                        console.error('進度條階段發生錯誤:', error);
                        resetFishing();
                    }
                } else {
                    // 沒有魚上鉤
                    setTimeout(() => {
                        gameAlert('今天運氣不好，沒有魚上鉤！', 'info', '釣魚結果', 3000);
                        resetFishing();
                    }, 500);
                }
            };
            
            // 移除釣竿階段超時機制，讓玩家有充足的時間點擊釣竿按鈕
            // 注意：原本的超時計時器已被移除，玩家可以無限時間點擊釣竿按鈕
            console.log('釣竿階段開始，玩家可以無限時間點擊釣竿按鈕');
            // fishingTimeoutId 設為 null，確保不會有超時處理
            fishingTimeoutId = null;
        }

        // 檢查是否有魚上鉤
        function checkForFish() {
            const locationFishes = fishes[gameData.currentLocation];
            // 隨機選擇一條魚
            const randomIndex = Math.floor(Math.random() * locationFishes.length);
            const selectedFish = locationFishes[randomIndex];
            
            // 直接返回選中的魚，確保100%上鉤率
            console.log('魚已上鉤：', selectedFish.name, '，100%上鉤率已生效');
            return selectedFish;
        }
        
        // 完成釣魚
        function completeFishing(success) {
            try {
                const fishAnimation = document.getElementById('fishAnimation');
                const progressContainer = document.getElementById('progressContainer');
                const progressBar = document.getElementById('progressBar');
                const rodButton = document.getElementById('rodButton');
                
                console.log('完成釣魚函數被調用，成功狀態:', success);
                
                // 確保清除所有計時器
                if (progressInterval) {
                    console.log('在completeFishing中清除進度條計時器');
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
                if (fishingTimeoutId) {
                    console.log('在completeFishing中清除釣魚超時計時器');
                    clearTimeout(fishingTimeoutId);
                    fishingTimeoutId = null;
                }
                
                // 隱藏所有釣魚相關元素
                if (fishAnimation) fishAnimation.style.display = 'none';
                if (progressContainer) progressContainer.style.display = 'none';
                if (progressBar) progressBar.style.width = '0%'; // 重置進度條寬度
                if (rodButton) rodButton.style.display = 'none';
                
                // 處理釣魚結果
                if (success && fishCaught) {
                    gameData.inventory.push(fishCaught);
                    updateInventory();
                    setTimeout(() => {
                        gameAlert(`恭喜！你釣到了 ${fishCaught.name}！`, 'success', '釣魚成功', 4000);
                        
                        // 自動保存遊戲
                        if (typeof autoSaveGame === 'function') {
                            autoSaveGame();
                        }
                    }, 100);
                } else if (isFishing) { // 只有在釣魚過程中才顯示失敗消息
                    setTimeout(() => {
                        gameAlert('可惜！魚跑掉了！', 'error', '釣魚失敗', 3000);
                    }, 100);
                }
                
                // 重置釣魚狀態
                resetFishing();
            } catch (error) {
                console.error('完成釣魚函數發生錯誤:', error);
                // 確保即使出錯也能重置釣魚狀態
                resetFishing();
            }
        }
        
        // 重置釣魚狀態
        function resetFishing() {
            try {
                const fishButton = document.querySelector('.fish-button');
                const fishingSpot = document.getElementById('fishingSpot');
                const rodButton = document.getElementById('rodButton');
                const fishAnimation = document.getElementById('fishAnimation');
                const progressContainer = document.getElementById('progressContainer');
                const progressBar = document.getElementById('progressBar');
                
                console.log('重置釣魚狀態');
                
                // 確保清除所有計時器
                if (progressInterval) {
                    console.log('在resetFishing中清除進度條計時器');
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
                if (fishingTimeoutId) {
                    console.log('在resetFishing中清除釣魚超時計時器');
                    clearTimeout(fishingTimeoutId);
                    fishingTimeoutId = null;
                }
                
                // 重置UI元素
                if (fishButton) {
                    fishButton.disabled = false;
                    fishButton.textContent = '開始釣魚';
                }
                
                // 清除所有事件處理器
                if (fishingSpot) fishingSpot.onclick = null;
                if (rodButton) rodButton.onclick = null;
                
                // 隱藏所有釣魚相關元素
                if (rodButton) rodButton.style.display = 'none';
                if (fishAnimation) fishAnimation.style.display = 'none';
                if (progressContainer) progressContainer.style.display = 'none';
                if (progressBar) progressBar.style.width = '0%';
                
                // 重置釣魚狀態變量
                isFishing = false;
                fishCaught = null;
                fishingStage = 0;
                rodTouchCount = 0;
            } catch (error) {
                console.error('重置釣魚狀態函數發生錯誤:', error);
                // 最後的安全措施：強制重置基本狀態
                isFishing = false;
                fishingStage = 0;
                fishCaught = null;
            }
        }

        // 更新背包顯示 - 設為全局函數
        window.updateInventory = function() {
            const inventoryList = document.getElementById('inventoryList');
            inventoryList.innerHTML = '';
            
            // 更新當前位置顯示
            document.getElementById('currentRod').textContent = gameData.currentRod.name;
            document.getElementById('money').textContent = gameData.money;
            
            // 如果背包為空，顯示提示信息
            if (gameData.inventory.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.textContent = '背包是空的，去釣些魚吧！';
                emptyDiv.style.fontStyle = 'italic';
                emptyDiv.style.color = '#888';
                inventoryList.appendChild(emptyDiv);
                return;
            }
            
            const fishCounts = {};
            gameData.inventory.forEach(fish => {
                fishCounts[fish.name] = (fishCounts[fish.name] || 0) + 1;
            });

            for (let fishName in fishCounts) {
                const fish = gameData.inventory.find(f => f.name === fishName);
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.padding = '5px 0';
                div.style.borderBottom = '1px solid #eee';
                
                const fishInfo = document.createElement('span');
                fishInfo.textContent = `${fishName} x${fishCounts[fishName]} (${fish.price}金幣)`;
                div.appendChild(fishInfo);
                
                const sellButton = document.createElement('button');
                sellButton.textContent = '賣出';
                sellButton.style.padding = '3px 8px';
                sellButton.style.backgroundColor = '#4CAF50';
                sellButton.style.color = 'white';
                sellButton.style.border = 'none';
                sellButton.style.borderRadius = '3px';
                sellButton.style.cursor = 'pointer';
                sellButton.onclick = () => sellFish(fishName);
                div.appendChild(sellButton);
                
                inventoryList.appendChild(div);
            }
        }

        // 賣出魚
        function sellFish(fishName) {
            // 使用帶有轉盤遊戲功能的函數
            sellFishWithWheel(fishName);
            
            // 自動保存遊戲
            if (typeof autoSaveGame === 'function') {
                setTimeout(autoSaveGame, 1000); // 延遲1秒保存，確保轉盤遊戲結果已處理
            }
        }

        // 商店功能
        function openShop() {
            const shopModal = document.getElementById('shopModal');
            const shopItems = document.getElementById('shopItems');
            shopItems.innerHTML = '';

            rods.forEach(rod => {
                if (rod.name !== gameData.currentRod.name) {
                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.margin = '8px 0';
                    div.style.borderRadius = '5px';
                    div.style.backgroundColor = '#f9f9f9';
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';
                    
                    const rodInfo = document.createElement('span');
                    rodInfo.innerHTML = `<strong>${rod.name}</strong><br>${rod.price}金幣 (力量: ${rod.power})`;
                    div.appendChild(rodInfo);
                    
                    const buyButton = document.createElement('button');
                    buyButton.textContent = '購買';
                    buyButton.onclick = () => buyRod(rod);
                    buyButton.disabled = gameData.money < rod.price;
                    if (gameData.money < rod.price) {
                        buyButton.style.opacity = '0.5';
                        buyButton.style.cursor = 'not-allowed';
                    }
                    div.appendChild(buyButton);
                    shopItems.appendChild(div);
                }
            });

            shopModal.style.display = 'flex';
            // 添加動畫效果
            setTimeout(() => {
                shopModal.classList.add('show');
            }, 10);
        }

        function closeShop() {
            const shopModal = document.getElementById('shopModal');
            shopModal.classList.remove('show');
            // 等待動畫完成後隱藏模態框
            setTimeout(() => {
                shopModal.style.display = 'none';
            }, 300);
        }

        // 購買釣竿
        function buyRod(rod) {
            if (gameData.money >= rod.price) {
                gameData.money -= rod.price;
                gameData.currentRod = rod;
                document.getElementById('currentRod').textContent = rod.name;
                updateInventory();
                closeShop();
                gameAlert(`成功購買 ${rod.name}！`, 'success', '購買成功', 3000);
                
                // 自動保存遊戲
                if (typeof autoSaveGame === 'function') {
                    autoSaveGame();
                }
            }
        }

        // 地圖功能
        function openMap() {
            const mapModal = document.getElementById('mapModal');
            const mapLocations = document.getElementById('mapLocations');
            mapLocations.innerHTML = '';

            Object.keys(fishes).forEach(location => {
                const div = document.createElement('div');
                div.style.padding = '12px';
                div.style.margin = '8px 0';
                div.style.borderRadius = '8px';
                div.style.cursor = 'pointer';
                div.style.transition = 'all 0.2s ease';
                div.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                
                // 創建位置圖標
                const locationIcon = document.createElement('span');
                locationIcon.innerHTML = '🗺️ ';
                locationIcon.style.marginRight = '8px';
                div.appendChild(locationIcon);
                
                // 創建位置文本
                const locationText = document.createElement('span');
                locationText.textContent = location;
                div.appendChild(locationText);
                
                // 添加傳送費用標籤
                const cost = travelCosts[location] || 0;
                if (cost > 0 && location !== gameData.currentLocation) {
                    const costTag = document.createElement('span');
                    costTag.textContent = ` (${cost} 金幣)`;
                    costTag.style.color = gameData.money >= cost ? '#4CAF50' : '#f44336';
                    costTag.style.fontWeight = 'bold';
                    locationText.appendChild(costTag);
                }
                
                if (location === gameData.currentLocation) {
                    div.style.fontWeight = 'bold';
                    div.style.backgroundColor = '#e0f7fa';
                    div.style.borderLeft = '4px solid #2e8cb8';
                    
                    const currentTag = document.createElement('span');
                    currentTag.textContent = ' (當前位置)';
                    currentTag.style.color = '#2e8cb8';
                    locationText.appendChild(currentTag);
                }
                
                // 添加魚類信息提示
                const fishInfo = document.createElement('div');
                fishInfo.style.fontSize = '0.8em';
                fishInfo.style.color = '#666';
                fishInfo.style.marginTop = '5px';
                fishInfo.style.marginLeft = '25px';
                
                const locationFishes = fishes[location];
                fishInfo.textContent = `可釣到: ${locationFishes.map(f => f.name).join(', ')}`;
                div.appendChild(fishInfo);
                
                div.onclick = () => changeLocation(location);
                div.addEventListener('mouseover', () => {
                    div.style.backgroundColor = location === gameData.currentLocation ? '#b2ebf2' : '#f5f5f5';
                    div.style.transform = 'translateY(-2px)';
                    div.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                });
                div.addEventListener('mouseout', () => {
                    div.style.backgroundColor = location === gameData.currentLocation ? '#e0f7fa' : '';
                    div.style.transform = 'translateY(0)';
                    div.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                });
                
                mapLocations.appendChild(div);
            });

            // 更新地圖彈窗中的金錢顯示
            document.getElementById('mapModalMoney').textContent = gameData.money;
            
            mapModal.style.display = 'flex';
            // 添加動畫效果
            setTimeout(() => {
                mapModal.classList.add('show');
            }, 10);
        }

        function closeMap() {
            const mapModal = document.getElementById('mapModal');
            mapModal.classList.remove('show');
            // 等待動畫完成後隱藏模態框
            setTimeout(() => {
                mapModal.style.display = 'none';
            }, 300);
        }

        // 更換釣魚地點
        function changeLocation(location) {
            if (location === gameData.currentLocation) {
                gameAlert(`你已經在 ${location} 了！`, 'info', '地點提示', 2000);
                closeMap();
                return;
            }
            
            // 檢查傳送費用
            const cost = travelCosts[location] || 0;
            if (cost > 0) {
                // 檢查玩家是否有足夠的金錢
                if (gameData.money < cost) {
                    gameAlert(`前往 ${location} 需要 ${cost} 金幣，但你只有 ${gameData.money} 金幣！`, 'error', '金錢不足', 3000);
                    closeMap();
                    return;
                }
                
                // 扣除傳送費用
                gameData.money -= cost;
                // 更新金錢顯示
                document.getElementById('money').textContent = gameData.money;
                gameAlert(`已支付 ${cost} 金幣前往 ${location}！`, 'info', '費用支付', 2000);
            }
            
            gameData.currentLocation = location;
            closeMap();
            
            // 更新UI顯示當前位置
            const locationDisplay = document.createElement('div');
            locationDisplay.textContent = `當前位置: ${location}`;
            locationDisplay.style.position = 'absolute';
            locationDisplay.style.top = '10px';
            locationDisplay.style.left = '10px';
            locationDisplay.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
            locationDisplay.style.padding = '5px 10px';
            locationDisplay.style.borderRadius = '5px';
            locationDisplay.style.zIndex = '10';
            locationDisplay.id = 'locationDisplay';
            
            // 移除舊的位置顯示（如果有）
            const oldLocationDisplay = document.getElementById('locationDisplay');
            if (oldLocationDisplay) {
                oldLocationDisplay.remove();
            }
            
            document.getElementById('fishingSpot').appendChild(locationDisplay);
            gameAlert(`已移動到 ${location}！`, 'success', '移動成功', 3000);
            
            // 自動保存遊戲
            if (typeof autoSaveGame === 'function') {
                autoSaveGame();
            }
        }

        // 初始化遊戲
        function initGame() {
            updateInventory();
            
            // 初始化顯示當前位置
            const locationDisplay = document.createElement('div');
            locationDisplay.textContent = `當前位置: ${gameData.currentLocation}`;
            locationDisplay.style.position = 'absolute';
            locationDisplay.style.top = '10px';
            locationDisplay.style.left = '10px';
            locationDisplay.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
            locationDisplay.style.padding = '5px 10px';
            locationDisplay.style.borderRadius = '5px';
            locationDisplay.style.zIndex = '10';
            locationDisplay.id = 'locationDisplay';
            document.getElementById('fishingSpot').appendChild(locationDisplay);
            
            // 添加版本號顯示
            const versionDisplay = document.createElement('div');
            versionDisplay.textContent = `${gameData.version}`;
            versionDisplay.style.position = 'fixed';
            versionDisplay.style.bottom = '10px';
            versionDisplay.style.right = '10px';
            versionDisplay.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
            versionDisplay.style.padding = '5px 10px';
            versionDisplay.style.borderRadius = '5px';
            versionDisplay.style.fontSize = '12px';
            versionDisplay.style.color = '#666';
            versionDisplay.style.zIndex = '1000';
            versionDisplay.id = 'versionDisplay';
            document.body.appendChild(versionDisplay);
        }
        
        // 啟動遊戲
        initGame();
    </script>
    
    <!-- 引入轉盤遊戲JS文件 -->
    <script src="wheel_game.js"></script>
    <!-- 引入通知系統JS文件 -->
    <script src="notification.js"></script>
    <!-- 引入存檔系統JS文件 -->
    <script src="save_system.js"></script>
    
    <script>
        // 在頁面加載完成後，初始化遊戲
        window.onload = function() {
            // 更新背包中的賣出按鈕，使用帶有轉盤遊戲的函數
            updateInventory();
            
            // 初始化存檔系統
            if (typeof initSaveSystem === 'function') {
                initSaveSystem();
            }
        }
    </script>
    
    <!-- 版權信息 -->
    <div style="position: fixed; bottom: 10px; left: 10px; background-color: rgba(0, 0, 0, 0.5); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 1000;">
        © sarguastudio
    </div>
</body>
</html>